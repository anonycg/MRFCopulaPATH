globals [
  SDOH_joint_dist_HETF
  SDOH_joint_dist_MSM
]

to-report assign_SDOH 
  let persons_desired-degree desired-degree
  let probabilities matrix:get-column SDOH_joint_dist_HETF (return-chosen-Bin2 persons_desired-degree)   ;"probablities" =probability disribution list ; picks the column corresponding to degree-bin
  if sex = 3 [set probabilities matrix:get-column SDOH_joint_dist_MSM (return-chosen-Bin2 persons_desired-degree) ] 
  let some_list (range 1 (item 0 matrix:dimensions SDOH_joint_dist_HETF + 1) ) ;create a list to represent the row index  
  report first rnd:weighted-one-of-list (map list some_list probabilities) last ; draw from the probability distribution "probablities" 
                                                                                ;reports  the SDOH_status
                                                                                ;SDOH status 0 = ABCDEF=00000
                                                                                ;;;;;;;;;;;; 0	1	2	3	4	5	6	7	8	9	10	11	12	13	14	15	16	17	18	19	20	21	22	23	24	25	26	27	28	29	30	31	32	33	34	35	36	37	38	39	40	41	42	43	44	45	46	47	48	49	50	51	52	53	54	55	56	57	58	59	60	61	62	63
                                                                                ;exchange sex	A	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1
                                                                                ;condom-use	  B	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1
                                                                                ;employment	  C	0	0	0	0	0	0	0	0	1	1	1	1	1	1	1	1	0	0	0	0	0	0	0	0	1	1	1	1	1	1	1	1	0	0	0	0	0	0	0	0	1	1	1	1	1	1	1	1	0	0	0	0	0	0	0	0	1	1	1	1	1	1	1	1
                                                                                ;housing	    D	0	0	0	0	1	1	1	1	0	0	0	0	1	1	1	1	0	0	0	0	1	1	1	1	0	0	0	0	1	1	1	1	0	0	0	0	1	1	1	1	0	0	0	0	1	1	1	1	0	0	0	0	1	1	1	1	0	0	0	0	1	1	1	1
                                                                                ;poverty	    E	0	0	1	1	0	0	1	1	0	0	1	1	0	0	1	1	0	0	1	1	0	0	1	1	0	0	1	1	0	0	1	1	0	0	1	1	0	0	1	1	0	0	1	1	0	0	1	1	0	0	1	1	0	0	1	1	0	0	1	1	0	0	1	1
                                                                                ;education	  F	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1	0	1
  
end

 to set_SDOH_status_update_degree
  set SDOH_status assign_SDOH
  ;if ticks > 240 and ExSexIntervention = true and SDOH_status > 32 [set desired-degree  round(desired-degree / 2.25)]; reduction of partners by 2.25 (RR value from literature. See Joint-dist_ExchnageSex.xlsx
  ; THIS HAS BEEN MOVED TO ECNA-geenrateNetwork-v2.nls
end 

to SDOH_joint_data
  
  set SDOH_joint_dist_HETF matrix:from-row-list [
  [	0.29571	0.29571	0.29571	0.29571	0.26712	0.26171	0.25519	0.24750	0.23860	]
[	0.02151	0.02151	0.02151	0.02151	0.01943	0.01904	0.01857	0.01801	0.01736	]
[	0.02234	0.02234	0.02234	0.02234	0.02018	0.01977	0.01928	0.01870	0.01802	]
[	0.00304	0.00304	0.00304	0.00304	0.00275	0.00269	0.00262	0.00255	0.00245	]
[	0.00009	0.00009	0.00009	0.00009	0.00009	0.00008	0.00008	0.00008	0.00008	]
[	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	]
[	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.00452	0.00452	0.00452	0.00452	0.00408	0.00400	0.00390	0.00378	0.00365	]
[	0.00111	0.00111	0.00111	0.00111	0.00101	0.00099	0.00096	0.00093	0.00090	]
[	0.00021	0.00021	0.00021	0.00021	0.00019	0.00018	0.00018	0.00017	0.00017	]
[	0.00010	0.00010	0.00010	0.00010	0.00009	0.00008	0.00008	0.00008	0.00008	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.55244	0.55244	0.55244	0.55244	0.49902	0.48892	0.47673	0.46237	0.44574	]
[	0.04019	0.04019	0.04019	0.04019	0.03631	0.03557	0.03468	0.03364	0.03243	]
[	0.04173	0.04173	0.04173	0.04173	0.03770	0.03693	0.03601	0.03493	0.03367	]
[	0.00568	0.00568	0.00568	0.00568	0.00513	0.00503	0.00490	0.00475	0.00458	]
[	0.00018	0.00018	0.00018	0.00018	0.00016	0.00016	0.00015	0.00015	0.00014	]
[	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	]
[	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.00845	0.00845	0.00845	0.00845	0.00763	0.00748	0.00729	0.00707	0.00682	]
[	0.00208	0.00208	0.00208	0.00208	0.00188	0.00184	0.00180	0.00174	0.00168	]
[	0.00039	0.00039	0.00039	0.00039	0.00035	0.00034	0.00034	0.00033	0.00031	]
[	0.00018	0.00018	0.00018	0.00018	0.00016	0.00016	0.00015	0.00015	0.00014	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.00000	0.00000	0.00000	0.00000	0.00570	0.00678	0.00808	0.00961	0.01139	]
[	0.00000	0.00000	0.00000	0.00000	0.00041	0.00049	0.00059	0.00070	0.00083	]
[	0.00000	0.00000	0.00000	0.00000	0.00632	0.00751	0.00895	0.01065	0.01262	]
[	0.00000	0.00000	0.00000	0.00000	0.00086	0.00102	0.00122	0.00145	0.00172	]
[	0.00000	0.00000	0.00000	0.00000	0.00009	0.00010	0.00012	0.00014	0.00017	]
[	0.00000	0.00000	0.00000	0.00000	0.00001	0.00001	0.00001	0.00001	0.00001	]
[	0.00000	0.00000	0.00000	0.00000	0.00009	0.00011	0.00013	0.00016	0.00019	]
[	0.00000	0.00000	0.00000	0.00000	0.00001	0.00002	0.00002	0.00002	0.00003	]
[	0.00000	0.00000	0.00000	0.00000	0.00205	0.00244	0.00290	0.00345	0.00409	]
[	0.00000	0.00000	0.00000	0.00000	0.00050	0.00060	0.00071	0.00085	0.00101	]
[	0.00000	0.00000	0.00000	0.00000	0.00138	0.00164	0.00196	0.00233	0.00276	]
[	0.00000	0.00000	0.00000	0.00000	0.00064	0.00076	0.00090	0.00107	0.00127	]
[	0.00000	0.00000	0.00000	0.00000	0.00003	0.00004	0.00004	0.00005	0.00006	]
[	0.00000	0.00000	0.00000	0.00000	0.00001	0.00001	0.00001	0.00001	0.00002	]
[	0.00000	0.00000	0.00000	0.00000	0.00002	0.00002	0.00003	0.00003	0.00004	]
[	0.00000	0.00000	0.00000	0.00000	0.00001	0.00001	0.00001	0.00002	0.00002	]
[	0.00000	0.00000	0.00000	0.00000	0.02471	0.02938	0.03501	0.04165	0.04935	]
[	0.00000	0.00000	0.00000	0.00000	0.00180	0.00214	0.00255	0.00303	0.00359	]
[	0.00000	0.00000	0.00000	0.00000	0.02737	0.03254	0.03878	0.04614	0.05467	]
[	0.00000	0.00000	0.00000	0.00000	0.00373	0.00443	0.00528	0.00628	0.00744	]
[	0.00000	0.00000	0.00000	0.00000	0.00037	0.00044	0.00052	0.00062	0.00074	]
[	0.00000	0.00000	0.00000	0.00000	0.00003	0.00003	0.00004	0.00005	0.00005	]
[	0.00000	0.00000	0.00000	0.00000	0.00041	0.00049	0.00058	0.00069	0.00082	]
[	0.00000	0.00000	0.00000	0.00000	0.00006	0.00007	0.00008	0.00009	0.00011	]
[	0.00000	0.00000	0.00000	0.00000	0.00888	0.01055	0.01258	0.01496	0.01773	]
[	0.00000	0.00000	0.00000	0.00000	0.00219	0.00260	0.00310	0.00369	0.00437	]
[	0.00000	0.00000	0.00000	0.00000	0.00599	0.00712	0.00849	0.01010	0.01196	]
[	0.00000	0.00000	0.00000	0.00000	0.00276	0.00328	0.00391	0.00465	0.00551	]
[	0.00000	0.00000	0.00000	0.00000	0.00013	0.00016	0.00019	0.00022	0.00027	]
[	0.00000	0.00000	0.00000	0.00000	0.00003	0.00004	0.00005	0.00006	0.00007	]
[	0.00000	0.00000	0.00000	0.00000	0.00009	0.00011	0.00013	0.00015	0.00018	]
[	0.00000	0.00000	0.00000	0.00000	0.00004	0.00005	0.00006	0.00007	0.00008	]
 
  ]
  set SDOH_joint_dist_MSM matrix:from-row-list [  
[	0.44702	0.44702	0.44702	0.44702	0.41678	0.40736	0.39488	0.37883	0.35874	]
[	0.03252	0.03252	0.03252	0.03252	0.03032	0.02964	0.02873	0.02756	0.02610	]
[	0.04138	0.04138	0.04138	0.04138	0.03859	0.03771	0.03656	0.03507	0.03321	]
[	0.00563	0.00563	0.00563	0.00563	0.00525	0.00513	0.00498	0.00477	0.00452	]
[	0.00057	0.00057	0.00057	0.00057	0.00053	0.00052	0.00050	0.00048	0.00046	]
[	0.00004	0.00004	0.00004	0.00004	0.00004	0.00004	0.00004	0.00004	0.00003	]
[	0.00005	0.00005	0.00005	0.00005	0.00005	0.00005	0.00005	0.00004	0.00004	]
[	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	]
[	0.01012	0.01012	0.01012	0.01012	0.00943	0.00922	0.00894	0.00857	0.00812	]
[	0.00249	0.00249	0.00249	0.00249	0.00232	0.00227	0.00220	0.00211	0.00200	]
[	0.00229	0.00229	0.00229	0.00229	0.00213	0.00209	0.00202	0.00194	0.00184	]
[	0.00105	0.00105	0.00105	0.00105	0.00098	0.00096	0.00093	0.00089	0.00085	]
[	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.37592	0.37592	0.37592	0.37592	0.35049	0.34257	0.33208	0.31857	0.30168	]
[	0.02735	0.02735	0.02735	0.02735	0.02550	0.02492	0.02416	0.02318	0.02195	]
[	0.03480	0.03480	0.03480	0.03480	0.03245	0.03171	0.03074	0.02949	0.02793	]
[	0.00474	0.00474	0.00474	0.00474	0.00442	0.00432	0.00419	0.00402	0.00380	]
[	0.00048	0.00048	0.00048	0.00048	0.00045	0.00044	0.00042	0.00041	0.00038	]
[	0.00003	0.00003	0.00003	0.00003	0.00003	0.00003	0.00003	0.00003	0.00003	]
[	0.00004	0.00004	0.00004	0.00004	0.00004	0.00004	0.00004	0.00004	0.00004	]
[	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00000	]
[	0.00851	0.00851	0.00851	0.00851	0.00793	0.00775	0.00751	0.00721	0.00683	]
[	0.00210	0.00210	0.00210	0.00210	0.00195	0.00191	0.00185	0.00178	0.00168	]
[	0.00192	0.00192	0.00192	0.00192	0.00179	0.00175	0.00170	0.00163	0.00154	]
[	0.00089	0.00089	0.00089	0.00089	0.00083	0.00081	0.00078	0.00075	0.00071	]
[	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	0.00001	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	]
[	0.00000	0.00000	0.00000	0.00000	0.02122	0.02784	0.03660	0.04787	0.06197	]
[	0.00000	0.00000	0.00000	0.00000	0.00154	0.00203	0.00266	0.00348	0.00451	]
[	0.00000	0.00000	0.00000	0.00000	0.00645	0.00845	0.01111	0.01454	0.01882	]
[	0.00000	0.00000	0.00000	0.00000	0.00088	0.00115	0.00151	0.00198	0.00256	]
[	0.00000	0.00000	0.00000	0.00000	0.00030	0.00040	0.00052	0.00068	0.00088	]
[	0.00000	0.00000	0.00000	0.00000	0.00002	0.00003	0.00004	0.00005	0.00006	]
[	0.00000	0.00000	0.00000	0.00000	0.00009	0.00012	0.00016	0.00021	0.00027	]
[	0.00000	0.00000	0.00000	0.00000	0.00001	0.00002	0.00002	0.00003	0.00004	]
[	0.00000	0.00000	0.00000	0.00000	0.00134	0.00176	0.00232	0.00303	0.00392	]
[	0.00000	0.00000	0.00000	0.00000	0.00033	0.00043	0.00057	0.00075	0.00097	]
[	0.00000	0.00000	0.00000	0.00000	0.00100	0.00131	0.00172	0.00225	0.00291	]
[	0.00000	0.00000	0.00000	0.00000	0.00046	0.00060	0.00079	0.00104	0.00134	]
[	0.00000	0.00000	0.00000	0.00000	0.00002	0.00003	0.00003	0.00004	0.00006	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00001	0.00001	0.00001	0.00001	]
[	0.00000	0.00000	0.00000	0.00000	0.00001	0.00002	0.00002	0.00003	0.00004	]
[	0.00000	0.00000	0.00000	0.00000	0.00001	0.00001	0.00001	0.00001	0.00002	]
[	0.00000	0.00000	0.00000	0.00000	0.02138	0.02804	0.03687	0.04822	0.06243	]
[	0.00000	0.00000	0.00000	0.00000	0.00156	0.00204	0.00268	0.00351	0.00454	]
[	0.00000	0.00000	0.00000	0.00000	0.00649	0.00852	0.01120	0.01464	0.01896	]
[	0.00000	0.00000	0.00000	0.00000	0.00088	0.00116	0.00152	0.00199	0.00258	]
[	0.00000	0.00000	0.00000	0.00000	0.00030	0.00040	0.00053	0.00069	0.00089	]
[	0.00000	0.00000	0.00000	0.00000	0.00002	0.00003	0.00004	0.00005	0.00006	]
[	0.00000	0.00000	0.00000	0.00000	0.00009	0.00012	0.00016	0.00021	0.00027	]
[	0.00000	0.00000	0.00000	0.00000	0.00001	0.00002	0.00002	0.00003	0.00004	]
[	0.00000	0.00000	0.00000	0.00000	0.00135	0.00177	0.00233	0.00305	0.00395	]
[	0.00000	0.00000	0.00000	0.00000	0.00033	0.00044	0.00057	0.00075	0.00097	]
[	0.00000	0.00000	0.00000	0.00000	0.00100	0.00132	0.00173	0.00226	0.00293	]
[	0.00000	0.00000	0.00000	0.00000	0.00046	0.00061	0.00080	0.00104	0.00135	]
[	0.00000	0.00000	0.00000	0.00000	0.00002	0.00003	0.00003	0.00004	0.00006	]
[	0.00000	0.00000	0.00000	0.00000	0.00000	0.00001	0.00001	0.00001	0.00001	]
[	0.00000	0.00000	0.00000	0.00000	0.00001	0.00002	0.00002	0.00003	0.00004	]
[	0.00000	0.00000	0.00000	0.00000	0.00001	0.00001	0.00001	0.00001	0.00002	]

  ]
end
to write_SDOH_header
  file-open "SDOH.csv"
  file-write "ticks"
  file-write  ( "HETF Pr(HIV|NoExSex)")
  file-write ( "HETF Pr(HIV|ExSex)")
  file-write ( "HETF Pr(HIV|ExSex) / Pr(HIV|NoExSex)")
  file-write ( "HETF Pr(ExSex|HIV)") 
  file-write  ( "HETM Pr(HIV|NoExSex)")
  file-write ( "HETM Pr(HIV|ExSex)")
  file-write ( "HETM Pr(HIV|ExSex) / Pr(HIV|NoExSex)")
  file-write ( "HETM Pr(ExSex|HIV)") 
  file-write  ( "MSM Pr(HIV|NoExSex)")
  file-write ( "MSM Pr(HIV|ExSex)")
  file-write ( "MSM Pr(HIV|ExSex) / Pr(HIV|NoExSex)")
  file-write ( "MSM Pr(ExSex|HIV)") 
  
  file-write "HETF: SDOH_status="     let j 1  repeat 64  [file-write  j   set j j + 1] file-write ("HETF: total people")
  file-write "HETM: SDOH_status="     set j 1  repeat 64  [file-write  j   set j j + 1] file-write ("HETM: total people")
  file-write "MSM: SDOH_status="     set j 1  repeat 64  [file-write  j   set j j + 1] file-write ("MSM: total people")
  
  file-write "HETF: degree_bin="   file-write  degree-dist-Bin file-write ("HETF: total people")
  file-write "HETM: degree_bin="   file-write  degree-dist-Bin file-write ("HETM: total people")
  file-write "MSM: degree_bin="    file-write degree-dist-Bin file-write ("MSM: total people")
  
  file-write "HETF:New_infections" 
  file-write "HETM:New_infections" 
  file-write "MSM:New_infections" 
    
  file-print ""
  file-close
end

to write_SDOH
  file-open "SDOH.csv"
  file-write random_seed
  file-write ticks
  let i 1
  
  repeat temp-num-sex[
    let a (count people with [dead = 0 and SDOH_status <= 32 and sex = i] / (item (i - 1) PopSize * (1 - 0.07)));7.1% =Pr(ExSex)
    let b (count people with [dead = 0 and SDOH_status > 32 and sex = i] / (item (i - 1) PopSize * 0.07));7.1% =Pr(ExSex)
    file-write  a
    file-write b
    file-write (b / a)
    file-write ((count people with [dead = 0 and SDOH_status > 32 and sex = i] / count people with [dead = 0 and sex = i]))
    set i i + 1
  ]
  
  set i 1
  repeat temp-num-sex[
    file-write "" 
    let j 1
    repeat 64  [
      file-write count people with [dead = 0 and sex = i and SDOH_status = j] /  count people with [dead = 0 and sex = i ]
      set j j + 1
    ]
    file-write count people with [dead = 0 and sex = i ]
    set i i + 1
  ]
  
  ;NOTE: degree dist will no more be different as it is kept same to enusre no change ECNA algorithm, but reduction in new contacts added (in ECNA network generation)
    set i 1
  repeat temp-num-sex[
    file-write ""
   file-write ""; not writing degree 0 so give one additional break 
    let j 1
    repeat length degree-dist-Bin - 1[
      file-write count people with [desired-degree <= item j degree-dist-Bin and desired-degree > item (j - 1) degree-dist-Bin and dead = 0 and sex = i] / count people with [dead = 0 and sex = i ]
      set j j + 1
    ]
    file-write count people with [dead = 0 and sex = i ]
    set i i + 1
  ]
  
  set i 1
  repeat temp-num-sex[file-write count people with [infected? = true  and (time-at-infection > ticks - 1 * time-unit) and sex = i]  set i i + 1]
  ;additions  
  set i 1
  repeat temp-num-sex[file-write count people with [infected? = true  and (time-at-infection > ticks - 1 * time-unit) and sex = i and SDOH_status <= 32]  set i i + 1]; new infections in presons who DO NOT exchange sex: by risk group
  set i 1
  repeat temp-num-sex[file-write count people with [infected? = true  and (time-at-infection > ticks - 1 * time-unit) and sex = i and SDOH_status > 32]  set i i + 1]; new infections in presons who exchange sex:by  risk group
  
  file-write count people with [infected? = true  and (time-at-infection > ticks - 1 * time-unit) and SDOH_status <= 32];new infections in presons who DO NOT exchange sex"total
  file-write count people with [infected? = true  and (time-at-infection > ticks - 1 * time-unit) and SDOH_status > 32];new infections in presons who exchange sex:total
  
  file-write count people with [infected? = true and dead = 0 and SDOH_status <= 32];PWH  who DO NOT exchange sex"total
  file-write count people with [infected? = true and dead = 0 and SDOH_status > 32];PWH  who exchange sex:total
  
  set i 1
  repeat temp-num-sex[file-write item (i - 1) PopSize  set i i + 1]; population size by risk group

  file-print ""
  file-close
end

